<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Join Bingo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #faf5ff;
      --panel: #ffffff;
      --primary: #7c3aed;
      --primary-dark: #5b21b6;
      --accent: #f97316;
      --border: rgba(124, 58, 237, 0.12);
      --text-muted: #5b556a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #ede9fe, #fdf2f8);
      color: #1f1434;
      padding: 24px;
    }

    h1, h2, h3, p {
      margin: 0;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(220px, 1fr);
      grid-template-areas: "main aside";
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .main-panel {
      grid-area: main;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .reference-panel {
      grid-area: aside;
      position: sticky;
      top: 24px;
      align-self: flex-start;
    }

    .card {
      background: var(--panel);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 18px 40px rgba(91, 33, 182, 0.12);
      border: 1px solid var(--border);
    }

    .hero h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .hero p {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .join-form {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 16px;
      align-items: end;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    input[type="text"] {
      width: 100%;
      padding: 14px;
      border-radius: 16px;
      border: 2px solid rgba(124, 58, 237, 0.35);
      font-size: 1rem;
      font-weight: 600;
      color: #1f1434;
    }

    button {
      font-family: inherit;
    }

    .primary-btn {
      border: none;
      border-radius: 16px;
      padding: 14px 28px;
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(120deg, var(--primary), var(--primary-dark));
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 14px 30px rgba(91, 33, 182, 0.35);
    }

    .primary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .join-hint {
      grid-column: 1 / -1;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }

    .stat {
      border-radius: 18px;
      padding: 16px;
      background: #f8f5ff;
      border: 1px solid var(--border);
    }

    .stat .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
    }

    .stat .value {
      font-size: 1.25rem;
      font-weight: 700;
      margin-top: 6px;
    }

    .call-card {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .call-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-chip {
      padding: 6px 16px;
      border-radius: 999px;
      background: rgba(124, 58, 237, 0.12);
      color: var(--primary-dark);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
    }

    .game-code {
      font-weight: 700;
      color: var(--text-muted);
    }

    .call-display {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .call-letter {
      width: 70px;
      height: 70px;
      border-radius: 20px;
      background: #f5f3ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 800;
      color: var(--primary);
      border: 2px solid var(--border);
    }

    .call-number {
      font-size: 3rem;
      font-weight: 800;
    }

    .drawn-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
    }

    .drawn-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #ede9fe;
      font-weight: 600;
      color: #4c1d95;
    }

    .board-card {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .board-heading {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
    }

    .cell {
      border-radius: 16px;
      min-height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 700;
      border: 2px solid rgba(31, 20, 52, 0.12);
      background: #fff;
      text-transform: uppercase;
    }

    .cell-head {
      background: var(--primary);
      color: #fff;
      border: none;
    }

    .cell-free {
      background: #fff4d8;
      border-color: #fbbf24;
      color: #b45309;
    }

    .cell-marked {
      background: #22c55e;
      color: #fff;
      border-color: #15803d;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.4);
    }

    .cell-ready {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.35);
      cursor: pointer;
    }

    .cell-ready:active {
      transform: scale(0.98);
    }

    .card-placeholder {
      text-align: center;
      color: var(--text-muted);
      font-weight: 600;
      padding: 40px 0;
    }

    .bingo-btn {
      width: 160px;
      padding: 14px;
      border-radius: 16px;
      border: none;
      font-weight: 800;
      letter-spacing: 1px;
      background: linear-gradient(120deg, #f59e0b, #f97316);
      color: #fff;
      cursor: pointer;
      box-shadow: 0 16px 30px rgba(249, 115, 22, 0.35);
    }

    .bingo-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .reference-card h3 {
      margin-bottom: 16px;
    }

    .reference-grid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 6px;
    }

    .ref-cell {
      border-radius: 12px;
      padding: 10px 0;
      text-align: center;
      font-weight: 600;
      color: #fff;
      background: rgba(255, 255, 255, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .ref-head {
      background: rgba(255, 255, 255, 0.5);
      color: #3b0764;
    }

    .ref-hit {
      background: #22c55e;
      border-color: #15803d;
      color: #fff;
      box-shadow: 0 10px 18px rgba(34, 197, 94, 0.35);
    }

    @media (max-width: 900px) {
      body {
        padding: 16px;
      }

      .layout {
        grid-template-columns: 1fr;
        grid-template-areas:
          "main"
          "aside";
      }

      .reference-panel {
        position: static;
      }
    }

    @media (max-width: 640px) {
      .join-form {
        grid-template-columns: 1fr;
      }

      .primary-btn,
      input[type="text"] {
        width: 100%;
      }

      .call-display {
        flex-direction: column;
        align-items: flex-start;
      }

      .cell {
        min-height: 56px;
        font-size: 1.1rem;
      }

      .board-heading {
        flex-direction: column;
        align-items: flex-start;
      }

      .bingo-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <main class="main-panel">
      <section class="card hero">
        <h1>Join the live bingo game</h1>
        <p>Enter your name, tap play, and your personalized card will appear instantly once the host opens a room.</p>
      </section>

      <section class="card join-card">
        <div class="join-form">
          <div>
            <label for="playerName">Your name</label>
            <input id="playerName" type="text" maxlength="20" autocomplete="off" placeholder="e.g. Jamie" />
          </div>
          <button class="primary-btn" id="joinBtn" data-join disabled>Play</button>
          <p class="join-hint" id="joinHint">Waiting for the host to open a game…</p>
        </div>
      </section>

      <section class="card">
        <div class="stat-grid">
          <div class="stat">
            <p class="label">Player</p>
            <p class="value" id="statPlayer">—</p>
          </div>
          <div class="stat">
            <p class="label">Game</p>
            <p class="value" id="statGame">—</p>
          </div>
          <div class="stat">
            <p class="label">Status</p>
            <p class="value" id="statStatus">Waiting</p>
          </div>
          <div class="stat">
            <p class="label">Drawn</p>
            <p class="value" id="statDrawn">0</p>
          </div>
        </div>
      </section>

      <section class="card call-card">
        <div class="call-meta">
          <span class="status-chip" id="statusChip">Waiting</span>
          <span class="game-code" id="gameCode">—</span>
        </div>
        <div class="call-display">
          <div class="call-letter" id="callLetter">–</div>
          <div class="call-number" id="callNumber">—</div>
        </div>
        <p id="callCaption" class="call-caption">No numbers yet.</p>
      </section>

      <section class="card">
        <h3>Recent calls</h3>
        <div class="drawn-list" id="drawnList"></div>
      </section>

      <section class="card board-card">
        <div class="board-heading">
          <h3>Your bingo card</h3>
          <button class="bingo-btn" id="bingoBtn" disabled>Bingo!</button>
        </div>
        <div id="playerCard" class="card-grid"></div>
      </section>
    </main>

    <aside class="reference-panel">
      <div class="card reference-card">
        <h3>Reference board</h3>
        <div class="reference-grid" id="referenceBoard"></div>
      </div>
    </aside>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const socket = io();
    const letters = ['B', 'I', 'N', 'G', 'O'];
    const state = {
      inviteCode: (new URLSearchParams(location.search).get('game') || '').toUpperCase(),
      activeGame: null,
      joinedGame: null,
      playerName: '',
      card: null,
      drawn: [],
      drawnSet: new Set(),
      started: false,
      closed: false,
      current: null
    };

    const ui = {
      nameInput: document.getElementById('playerName'),
      joinBtn: document.getElementById('joinBtn'),
      joinHint: document.getElementById('joinHint'),
      statPlayer: document.getElementById('statPlayer'),
      statGame: document.getElementById('statGame'),
      statStatus: document.getElementById('statStatus'),
      statDrawn: document.getElementById('statDrawn'),
      statusChip: document.getElementById('statusChip'),
      gameCode: document.getElementById('gameCode'),
      callLetter: document.getElementById('callLetter'),
      callNumber: document.getElementById('callNumber'),
      callCaption: document.getElementById('callCaption'),
      drawnList: document.getElementById('drawnList'),
      cardGrid: document.getElementById('playerCard'),
      bingoBtn: document.getElementById('bingoBtn'),
      referenceBoard: document.getElementById('referenceBoard')
    };

    function getTargetGame() {
      return state.joinedGame || state.inviteCode || state.activeGame || '';
    }

    function updateJoinHint(message) {
      if (message) {
        ui.joinHint.textContent = message;
        return;
      }
      if (state.card) {
        ui.joinHint.textContent = state.closed
          ? 'Game finished. Wait for the host to reset to play again.'
          : 'You are in! Watch the numbers and tap Bingo when ready.';
        return;
      }
      if (state.inviteCode) {
        ui.joinHint.textContent = `Invite detected for game ${state.inviteCode}. Enter your name to play.`;
        return;
      }
      if (state.activeGame) {
        ui.joinHint.textContent = `Game ${state.activeGame} is live. Enter your name to jump in.`;
        return;
      }
      ui.joinHint.textContent = 'Waiting for the host to open a game…';
    }

    function updateJoinButton(label) {
      if (label) ui.joinBtn.textContent = label;
      if (state.card) {
        ui.joinBtn.disabled = true;
        ui.joinBtn.textContent = 'In game';
        return;
      }
      const hasGame = Boolean(getTargetGame());
      const hasName = Boolean(ui.nameInput.value.trim());
      ui.joinBtn.disabled = !(hasGame && hasName);
      if (!label) ui.joinBtn.textContent = 'Play';
    }

    function bingoLetter(number) {
      if (number >= 1 && number <= 15) return 'B';
      if (number <= 30) return 'I';
      if (number <= 45) return 'N';
      if (number <= 60) return 'G';
      if (number <= 75) return 'O';
      return '';
    }

    function renderCard() {
      if (!state.card) {
        ui.cardGrid.innerHTML = '<p class="card-placeholder">Enter your name and tap Play to receive your card.</p>';
        return;
      }
      let html = '';
      for (const letter of letters) {
        html += `<div class="cell cell-head">${letter}</div>`;
      }
      for (let row = 0; row < 5; row += 1) {
        for (let col = 0; col < 5; col += 1) {
          const value = state.card.numbers[col][row];
          const marked = state.card.marked[row][col];
          const classes = ['cell'];
          if (value === 'FREE') classes.push('cell-free');
          if (marked) {
            classes.push('cell-marked');
          } else if (state.started && !state.closed && value !== 'FREE' && state.drawnSet.has(value)) {
            classes.push('cell-ready');
          }
          const attrs = `data-row="${row}" data-col="${col}" data-value="${value}"`;
          html += `<div class="${classes.join(' ')}" ${attrs}>${value}</div>`;
        }
      }
      ui.cardGrid.innerHTML = html;
    }

    function renderReferenceBoard() {
      let html = '';
      for (const letter of letters) {
        html += `<div class="ref-cell ref-head">${letter}</div>`;
      }
      for (let row = 0; row < 15; row += 1) {
        for (let col = 0; col < 5; col += 1) {
          const number = col * 15 + (row + 1);
          html += `<div class="ref-cell" data-ref="${number}">${number}</div>`;
        }
      }
      ui.referenceBoard.innerHTML = html;
    }

    function updateReferenceMarks() {
      ui.referenceBoard.querySelectorAll('[data-ref]').forEach(cell => {
        const value = Number(cell.getAttribute('data-ref'));
        cell.classList.toggle('ref-hit', state.drawnSet.has(value));
      });
    }

    function renderDrawn(list) {
      if (!list.length) {
        ui.drawnList.innerHTML = '<p class="card-placeholder" style="padding:16px 0;">No numbers yet.</p>';
        return;
      }
      const recent = list.slice(-12).reverse();
      ui.drawnList.innerHTML = recent.map(num => {
        const letter = bingoLetter(num);
        return `<span class="drawn-pill"><strong>${letter}</strong> ${num}</span>`;
      }).join('');
    }

    function setCurrent(number) {
      state.current = number ?? null;
      if (number) {
        ui.callLetter.textContent = bingoLetter(number);
        ui.callNumber.textContent = number;
        ui.callCaption.textContent = 'Mark the number on your card if you have it.';
      } else {
        ui.callLetter.textContent = '–';
        ui.callNumber.textContent = '—';
        ui.callCaption.textContent = state.started ? 'Waiting for the next draw…' : 'No numbers yet.';
      }
    }

    function updateStats() {
      const status = state.closed ? 'Finished' : (state.started ? 'In progress' : 'Waiting');
      ui.statPlayer.textContent = state.playerName || '—';
      ui.statGame.textContent = getTargetGame() || '—';
      ui.statStatus.textContent = status;
      ui.statDrawn.textContent = state.drawn.length.toString();
      ui.statusChip.textContent = status;
      ui.gameCode.textContent = state.joinedGame ? `#${state.joinedGame}` : (state.activeGame ? `#${state.activeGame}` : '—');
    }

    function updateActions() {
      ui.bingoBtn.disabled = !(state.card && state.started && !state.closed);
    }

    function attemptJoin() {
      if (state.card) return;
      const targetGame = getTargetGame();
      if (!targetGame) {
        updateJoinHint('Waiting for the host to open a game…');
        return;
      }
      const desiredName = ui.nameInput.value.trim();
      if (!desiredName) {
        ui.nameInput.focus();
        return;
      }
      ui.joinBtn.disabled = true;
      ui.joinBtn.textContent = 'Joining…';
      socket.emit('player:join', { gameId: targetGame, name: desiredName }, response => {
        if (!response?.ok) {
          updateJoinHint(response?.error || 'Unable to join right now.');
          updateJoinButton();
          return;
        }
        state.card = response.card;
        state.joinedGame = response.gameId || targetGame;
        state.playerName = desiredName;
        state.drawn = response.drawn || [];
        state.drawnSet = new Set(state.drawn);
        state.started = Boolean(response.started);
        state.closed = Boolean(response.closed);
        ui.nameInput.value = desiredName;
        ui.nameInput.disabled = true;
        setCurrent(state.drawn[state.drawn.length - 1] || null);
        renderCard();
        renderDrawn(state.drawn);
        updateReferenceMarks();
        updateStats();
        updateJoinHint();
        updateActions();
        updateJoinButton();
      });
    }

    ui.nameInput.addEventListener('input', () => {
      if (!state.card) updateJoinButton();
    });

    ui.joinBtn.addEventListener('click', attemptJoin);

    ui.cardGrid.addEventListener('click', event => {
      const cell = event.target.closest('[data-row]');
      if (!cell || !state.card || !state.started || state.closed) return;
      const row = Number(cell.getAttribute('data-row'));
      const col = Number(cell.getAttribute('data-col'));
      if (state.card.marked[row][col]) return;
      const value = cell.getAttribute('data-value');
      if (value === 'FREE' || !state.drawnSet.has(Number(value))) return;
      socket.emit('player:mark', { gameId: state.joinedGame, row, col }, res => {
        if (!res?.ok) return;
        state.card.marked[row][col] = true;
        renderCard();
        updateActions();
      });
    });

    ui.bingoBtn.addEventListener('click', () => {
      if (!state.joinedGame) return;
      socket.emit('player:claim', { gameId: state.joinedGame }, res => {
        if (!res?.ok) return;
        if (!res.valid && res.disqualified) {
          alert('No bingo detected. You have been disqualified for this round.');
        }
      });
    });

    socket.on('game:available', ({ gameId }) => {
      state.activeGame = gameId || '';
      if (!state.card) {
        updateJoinHint();
        updateJoinButton();
      }
      updateStats();
    });

    socket.on('number:drawn', ({ number, drawn }) => {
      state.drawn = drawn || [];
      state.drawnSet = new Set(state.drawn);
      setCurrent(number || null);
      renderDrawn(state.drawn);
      updateReferenceMarks();
      renderCard();
      updateStats();
      updateActions();
    });

    socket.on('state:meta', meta => {
      state.started = Boolean(meta.started);
      state.closed = Boolean(meta.closed);
      if (typeof meta.current === 'number') {
        setCurrent(meta.current);
      } else if (!state.drawn.length) {
        setCurrent(null);
      }
      updateStats();
      updateJoinHint();
      updateActions();
    });

    socket.on('game:winner', () => {
      state.closed = true;
      updateStats();
      updateJoinHint('Bingo! The round has finished. Wait for the host to reset.');
      updateActions();
    });

    socket.on('game:reset', () => {
      state.card = null;
      state.drawn = [];
      state.drawnSet = new Set();
      state.started = false;
      state.closed = false;
      state.current = null;
      ui.nameInput.disabled = false;
      updateJoinHint('Game reset! Tap Play again to receive a fresh card.');
      updateJoinButton();
      renderCard();
      renderDrawn([]);
      updateReferenceMarks();
      setCurrent(null);
      updateStats();
      updateActions();
    });

    renderReferenceBoard();
    renderCard();
    renderDrawn([]);
    setCurrent(null);
    updateStats();
    updateJoinHint();
    updateJoinButton();
  </script>
</body>
</html>
