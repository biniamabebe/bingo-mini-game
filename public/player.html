<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Bingo ‚Äì Join Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:Arial, sans-serif;background:#eef2ff;margin:0;padding:18px;}
    .wrap{max-width:980px;margin:0 auto;background:#fff;border-radius:12px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,.08);}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    input{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;}
    .btn{padding:10px 16px;border:0;border-radius:8px;cursor:pointer;font-weight:bold;}
    .primary{background:#2563eb;color:#fff;}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:14px;}
    .cell{aspect-ratio:1;border:2px solid #4b5563;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:bold;background:#fff;}
    .head{background:#1f2937;color:#fff;}
    .free{background:#10b981;color:#fff;}
    .marked{background:#fbbf24;border-color:#f59e0b;}
    .markable{cursor:pointer;}
    .panel{margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .box{border:1px solid #e5e7eb;padding:12px;border-radius:10px;background:#fafafa;}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#e0e7ff;color:#3730a3;font-weight:bold;margin:4px;}
    .bingo{width:100%;margin-top:10px;padding:12px;font-size:1.1rem;background:#16a34a;color:#fff;border:0;border-radius:10px;cursor:pointer;}
    .bingo:disabled{background:#9ca3af;cursor:not-allowed;}
    .current{font-size:1.6rem;font-weight:bold;padding:10px;background:#fff7ed;border:1px solid #ffedd5;border-radius:10px;text-align:center;}
    .bingo-bar{display:flex;gap:8px;justify-content:center;align-items:center;margin:8px 0;}
    .cartel-card{display:flex;gap:8px;justify-content:center;align-items:center;margin:8px 0;}
    .b-letter{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid #d1d5db;background:#f8fafc;font-weight:bold;}
    .b-letter.active{background:#1f2937;color:#fff;border-color:#1f2937;transform:scale(1.05);}
    .hint{color:#6b7280;}
   /* Layout: always 2 columns */
.layout {
  display: grid;
  grid-template-columns: 1.7fr 1fr; /* left : right */
  gap: 16px;
  align-items: start;
}

/* Panels */
.wrap {
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  box-shadow: 0 8px 20px rgba(0,0,0,.08);
}

/* Right side (big reference board) is sticky */
.refpanel {
  position: sticky;
  top: 12px;
  align-self: start;
}

/* Big reference board */
.refgrid{
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  grid-auto-rows: 42px;              /* header + cells uniform height; tweak if needed */
  gap:0;                             /* no gaps ‚Äî we‚Äôll draw grid lines with borders */
  border:2px solid #1f2937;          /* outer border */
  border-radius:8px;
  overflow:hidden;                   /* clip inner borders to radius */
}
.refhead{
  background:#1f2937;
  color:#fff;
  font-weight:800;
  display:flex; align-items:center; justify-content:center;
  font-size:1rem;
  border-right:1px solid #0f172a;
  border-bottom:1px solid #0f172a;
}
.refcell{
  display:flex; align-items:center; justify-content:center;
  font-weight:700; font-size:0.95rem;
  background:#fff; color:#111827;
  border-right:1px solid #cbd5e1;    /* grid vertical lines */
  border-bottom:1px solid #cbd5e1;   /* grid horizontal lines */
}
.refgrid > :nth-child(5n){ border-right:none; }          /* every 5th cell */
.refgrid > :nth-last-child(-n+5){ border-bottom:none; } 

.refcell.ref-marked { background: #16a34a; color: #fff; border-color: #15803d; }

  </style>
</head>
<body>
    
  <div class="layout">
    <div class="wrap ">
    <h2>üéØ Join Bingo</h2>
    <p class="hint">Enter the code from the host, or use a link like <code>/join?game=ABCD</code>.</p>
    <div class="row">
      <input id="code" placeholder="Game code (e.g. 7K3F)" style="text-transform:uppercase"/>
      <input id="name" placeholder="Your name (max 20 chars)" maxlength="20"/>
      <button id="joinBtn" class="btn primary">Join</button>
    </div>

    <div style="margin-top:10px;" class="current">Current: <span id="current">‚Äî</span></div>
    <div class="box">
        <h3>Drawn Numbers</h3>
        <div id="drawn"></div>
      </div>

    <div id="board"></div>

    <div class="panel">
      
      <div class="box">
        <h3>Status</h3>
        <div>Started: <b id="st">‚Äî</b></div>
        <div>Ended: <b id="en">‚Äî</b></div>
        <button id="bingoBtn" class="bingo" disabled>üéØ BINGO!</button>
      </div>
    </div>
    </div>
    <aside class="refpanel">
        <div class="wrap">
            <h3>All Numbers (Auto-marked)</h3>
            <div id="refBoard" class="refgrid"></div>
        </div>
    </aside>
  </div>
    

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const socket = io();
    const el = id => document.getElementById(id);

        // Build the static 1‚Äì75 reference board once
   function buildRefBoard(){
        const ref = document.getElementById('refBoard');
        if (!ref) return;

        let html = '';
        // Header row (exactly 5 items)
        ['B','I','N','G','O'].forEach(h => {
            html += `<div class="refhead">${h}</div>`;
        });

        // 15 rows √ó 5 cols of numbers under the right letter
        for (let row = 0; row < 15; row++) {
            for (let col = 0; col < 5; col++) {
            const n = col * 15 + (row + 1);  // B 1‚Äì15, I 16‚Äì30, N 31‚Äì45, G 46‚Äì60, O 61‚Äì75
            html += `<div class="refcell" data-ref="${n}">${n}</div>`;
            }
            }

    ref.innerHTML = html;
    }


    // Mark/unmark cells on the reference board from drawnSet
    function updateRefMarks(){
    const ref = document.getElementById('refBoard');
    if (!ref) return;
    ref.querySelectorAll('.refcell').forEach(cell => {
        const n = +cell.dataset.ref;
        if (drawnSet.has(n)) cell.classList.add('ref-marked');
        else cell.classList.remove('ref-marked');
    });
    }

    function bingoLetter(n){
      if(n>=1 && n<=15) return 'B';
      if(n<=30) return 'I';
      if(n<=45) return 'N';
      if(n<=60) return 'G';
      return 'O';
    }
    function highlightLetter(L){
      ['B','I','N','G','O'].forEach(ch=>{
        const x = el('L_'+ch); if(!x) return;
        if(ch===L) x.classList.add('active'); else x.classList.remove('active');
      });
    }
    function setCurrent(n){
      if(n==null){ el('current').textContent='‚Äî'; highlightLetter(null); return; }
      const L=bingoLetter(n);
      el('current').textContent = `${L}-${n}`;
      highlightLetter(L);
    }

    let gameId=null, card=null, started=false, closed=false, drawnSet=new Set();
    buildRefBoard();           // ‚Üê builds the static 1‚Äì75 grid one time
    updateRefMarks();          // ‚Üê ensures it starts with no highlights

    // Pre-fill from ?game=CODE
    const pre = (new URLSearchParams(location.search).get('game')||'').toUpperCase();
    if(pre) el('code').value = pre;

    function renderCard(){
      if(!card){ el('board').innerHTML=''; return; }
      let html='<div class="grid">';
      ['B','I','N','G','O'].forEach(h=>html+=`<div class="cell head">${h}</div>`);
      for(let r=0;r<5;r++){
        for(let c=0;c<5;c++){
          const n=card.numbers[c][r];
          const isFree=n==='FREE';
          const isMarked=card.marked[r][c];
          const isDrawn=!isFree && drawnSet.has(n);
          const canMark=started && !closed && !isFree && !isMarked && isDrawn;
          let cls='cell'; if(isFree) cls+=' free'; if(isMarked) cls+=' marked'; if(canMark) cls+=' markable';
          html+=`<div class="${cls}" data-r="${r}" data-c="${c}">${n}</div>`;
        }
      }
      html+='</div>'; el('board').innerHTML=html;

      el('board').querySelectorAll('.cell.markable').forEach(cell=>{
        cell.onclick=()=>{
          const r=+cell.dataset.r, c=+cell.dataset.c;
          socket.emit('player:mark',{gameId,row:r,col:c},(res)=>{
            if(res?.ok && res.marked){ card.marked[r][c]=true; renderCard(); }
            else if(res?.error){ alert(res.error); }
          });
        };
      });
    }

    function renderDrawn(nums){
        const last5 = nums.slice(-5);
        document.getElementById('drawn').innerHTML =
        last5.map(n => `<span class="pill">${bingoLetter(n)}-${n}</span>`).join('');
    }

    function setMeta(){ el('st').textContent=started?'Yes':'No'; el('en').textContent=closed?'Yes':'No'; el('bingoBtn').disabled=!started||closed; }

    el('joinBtn').onclick=()=>{
      const code=el('code').value.trim().toUpperCase();
      const name=el('name').value.trim();
      if(!code||!name) return alert('Enter code and name');
      socket.emit('player:join',{gameId:code,name},(res)=>{
        if(!res.ok) return alert(res.error||'Join failed');
        gameId=code; card=res.card; started=res.started; closed=res.closed;
        drawnSet=new Set(res.drawn||[]); updateRefMarks(); renderCard(); renderDrawn(res.drawn||[]); setMeta();
        const last=(res.drawn&&res.drawn.length)?res.drawn[res.drawn.length-1]:null;
        setCurrent(last);
      });
    };

    el('bingoBtn').onclick=()=>{
      if(!gameId) return;
      socket.emit('player:claim',{gameId},(res)=>{
        if(!res?.ok) return;
        if(!res.valid && res.disqualified) alert('‚ùå False claim ‚Äì you are disqualified.');
      });
    };

    socket.on('number:drawn',({number,drawn})=>{
      drawnSet=new Set(drawn); updateRefMarks(); renderDrawn(drawn); renderCard(); setCurrent(number);
    });
    socket.on('state:meta',(s)=>{
      started=!!s.started; closed=!!s.closed; setMeta(); setCurrent((s.current??null));
    });
    socket.on('game:winner',(w)=>{ closed=true; setMeta(); /* optional modal */ });
    socket.on('game:reset',()=>{
      card=null; started=false; closed=false; drawnSet=new Set();updateRefMarks();
      renderCard(); renderDrawn([]); setMeta(); setCurrent(null);
    });
  </script>
</body>
</html>
